<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="数据库系统原理——MySQL架构篇, Gustavo">
    <meta name="description" content="MySQL架构篇1.MySQL服务器环境
OS：CentOS 7.6

MySQL：MySQL 5.7.30


2.MySQL架构图2.1 逻辑架构图

Connectors连接器：负责跟客户端建立连接

Management Serve">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="referrer" content="no-referrer"/>
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>数据库系统原理——MySQL架构篇 | Gustavo</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <style>
        body{
            background-image: url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);
            background-repeat:no-repeat;
            background-size: 100% 100%;
            background-attachment:fixed;
        }
    </style>



    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Gustavo" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Gustavo</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Gustavo</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/gustavo1841" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/gustavo1841" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/777.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">数据库系统原理——MySQL架构篇</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/">
                                <span class="chip bg-color">计算机</span>
                            </a>
                        
                            <a href="/tags/Java/">
                                <span class="chip bg-color">Java</span>
                            </a>
                        
                            <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                                <span class="chip bg-color">数据库</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" class="post-category">
                                计算机
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-04-25
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-04-26
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    10.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    37 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="MySQL架构篇"><a href="#MySQL架构篇" class="headerlink" title="MySQL架构篇"></a>MySQL架构篇</h1><h2 id="1-MySQL服务器环境"><a href="#1-MySQL服务器环境" class="headerlink" title="1.MySQL服务器环境"></a>1.MySQL服务器环境</h2><ul>
<li><p>OS：CentOS 7.6</p>
</li>
<li><p>MySQL：MySQL 5.7.30</p>
</li>
</ul>
<h2 id="2-MySQL架构图"><a href="#2-MySQL架构图" class="headerlink" title="2.MySQL架构图"></a>2.MySQL架构图</h2><h3 id="2-1-逻辑架构图"><a href="#2-1-逻辑架构图" class="headerlink" title="2.1 逻辑架构图"></a>2.1 逻辑架构图</h3><p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425145716649.png"></p>
<ul>
<li><p>Connectors连接器：负责跟客户端建立连接</p>
</li>
<li><p>Management Serveices &amp; Utilities系统管理和控制工具</p>
</li>
<li><p>Connection Pool连接池：管理用户连接，监听并接收连接的请求，转发所有连接的请求到线程管理模块</p>
</li>
<li><p>SQL Interface SQL接口：接受用户的SQL命令，并且返回SQL执行结果</p>
</li>
<li><p>Parser解析器：SQL传递到解析器的时候会被解析器验证和解析</p>
</li>
<li><p>Optimizer查询优化器：SQL语句在查询之前会使用查询优化器对查询进行优化，explain语句查看的SQL语句执行计划，就是由此优化器生成</p>
</li>
<li><p>Cache和Buffer查询缓存：在MySQL5.7中包含缓存组件。在MySQL8中移除了</p>
</li>
<li><p>Pluggable Storage Engines存储引擎：存储引擎就是存取数据、建立与更新索引、查询数据等技术的实现方法</p>
</li>
</ul>
<h3 id="2-2-MySQL日志文件"><a href="#2-2-MySQL日志文件" class="headerlink" title="2.2 MySQL日志文件"></a>2.2 MySQL日志文件</h3><p>MySQL是通过文件系统对数据索引后进行存储的，MySQL从物理结构上可以分为日志文件和数据及索引文件。MySQL在Linux中的数据索引文件和日志文件通常放在/var/lib/mysql目录下。MySQL通过日志记录了数据库操作信息和错误信息。</p>
<p>常用日志文件如下：</p>
<ol>
<li><p>错误日志：/var/log/mysql-error.log</p>
</li>
<li><p>二进制日志：/var/lib/mysql/mysql-bin</p>
</li>
<li><p>查询日志：general_query.log</p>
</li>
<li><p>慢查询日志：slow_query_log.log</p>
</li>
<li><p>事务重做日志：redo log</p>
</li>
<li><p>中继日志：relay log</p>
</li>
</ol>
<p>可以通过命令查看当前数据库中的日志使用信息：</p>
<pre class="line-numbers language-none"><code class="language-none">mysql&gt; show variables like 'log_%';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425145851935.png"></p>
<h4 id="2-2-1-错误日志：error-log"><a href="#2-2-1-错误日志：error-log" class="headerlink" title="2.2.1 错误日志：error log"></a>2.2.1 错误日志：error log</h4><p>默认开启，错误日志记录了运行过程中遇到的所有严重的错误信息，以及 MySQL每次启动和关闭的详细信息。错误日志所记录的信息是可以通过log_error和log_warnings配置来定义的。从5.5.7以后不能关闭错误日志。</p>
<ul>
<li><p>log_error：指定错误日志存储位置</p>
</li>
<li><p>log-warnings：是否将警告信息输出到错误日志中。</p>
<ul>
<li><p>log_warnings 为0， 表示不记录告警信息。</p>
</li>
<li><p>log_warnings 为1， 表示告警信息写入错误日志。</p>
</li>
<li><p>log_warnings 大于1， 表示各类告警信息，例如：有关网络故障的信息和重新连接信息写入错误日志。</p>
</li>
</ul>
</li>
</ul>
<h4 id="2-2-2-二进制日志：bin-log"><a href="#2-2-2-二进制日志：bin-log" class="headerlink" title="2.2.2 二进制日志：bin log"></a>2.2.2 二进制日志：bin log</h4><p>默认关闭，需要通过以下配置进行开启。binlog记录了数据库所有的ddl语句和dml语句，但不包括select语句内容，语句以事件的形式保存，描述了数据的变更顺序，binlog还包括了每个更新语句的执行时间信息。如果是DDL语句，则直接记录到binlog日志，而DML语句，必须通过事务提交才能记录到binlog日志中。</p>
<p>binlog主要用于实现mysql主从复制、数据备份、数据恢复。</p>
<p>配置中mysql-bin是binlog日志文件的basename，binlog日志文件的完整名称：mysql-bin.000001。</p>
<pre class="line-numbers language-none"><code class="language-none">server_id=42
log-bin=mysql-bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>数据定义语言：简称DDL(Data Definition Language)</p>
<ul>
<li><p>作用：用来定义数据库对象：数据库，表，列等。</p>
</li>
<li><p>关键字：create，alter，drop等</p>
</li>
</ul>
<p>数据操作语言：简称DML(Data Manipulation Language)，</p>
<ul>
<li><p>作用：用来对数据库中表的记录进行更新。</p>
</li>
<li><p>关键字：insert，delete，update等</p>
</li>
</ul>
<p>数据查询语言：简称DQL(Data Query Language)</p>
<ul>
<li><p>作用：用来查询数据库中表的记录。</p>
</li>
<li><p>关键字：select，from，where等</p>
</li>
</ul>
<p>数据控制语言：简称DCL(Data Control Language)</p>
<ul>
<li>作用：用来定义数据库的访问权限和安全级别，及创建用户。</li>
</ul>
</blockquote>
<h4 id="2-2-3-通用查询日志：general-query-log"><a href="#2-2-3-通用查询日志：general-query-log" class="headerlink" title="2.2.3 通用查询日志：general query log"></a>2.2.3 通用查询日志：general query log</h4><p>默认关闭，由于通用查询日志会记录用户的所有操作，其中还包含增删查改等信息，在并发操作大的环境下会产生大量的信息从而导致不必要的磁盘IO，会影响MySQL的性能的。</p>
<p>如果不是为了调试数据库，不建议开启查询日志。</p>
<pre class="line-numbers language-none"><code class="language-none"># 查询通用查询日志变量信息
mysql&gt; show global variables like '%general_log%';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>开启方式：</p>
<pre class="line-numbers language-none"><code class="language-none">#启动开关
general_log={ON|OFF}
#日志文件变量，而general_log_file如果没有指定，默认名是host_name.log
general_log_file=/var/lib/mysql/host_name.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-2-4-慢查询日志：slow-query-log"><a href="#2-2-4-慢查询日志：slow-query-log" class="headerlink" title="2.2.4 慢查询日志：slow query log"></a>2.2.4 慢查询日志：slow query log</h4><p>默认关闭，通过以下设置开启。记录执行时间超过long_query_time秒的所有查询，便于收集查询时间比较长的SQL语句。</p>
<p>查看阈值</p>
<pre class="line-numbers language-none"><code class="language-none">show global status like '%Slow_queries%';
show variables like '%slow_query%';
show variables like 'long_query_time%';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>配置慢查询开启</p>
<pre class="line-numbers language-none"><code class="language-none"># 开启慢查询日志
slow_query_log=ON
# 慢查询的阈值，单位秒
long_query_time=10
# 日志记录文件
# 如果没有给出file_name值， 默认为主机名，后缀为-slow.log。
# 如果给出了文件名，但不是绝对路径名，文件则写入数据目录。
slow_query_log_file=slow_query_log.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="2-3-MySQL数据文件"><a href="#2-3-MySQL数据文件" class="headerlink" title="2.3 MySQL数据文件"></a>2.3 MySQL数据文件</h3><p>查看MySQL数据文件：</p>
<pre class="line-numbers language-none"><code class="language-none">show variables like '%datadir%';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ibdata文件：使用系统表空间存储表数据和索引信息，所有表共同使用一个或者多个ibdata文件。</p>
<p>InnoDB存储引擎的数据文件：</p>
<ul>
<li><p>.frm文件：主要存放与表相关的数据信息，主要包括表结构的定义信息</p>
</li>
<li><p>.ibd：使用独享表空间存储表数据和索引信息，一张表对应一个ibd文件。</p>
</li>
</ul>
<p>MyISAM存储引擎的数据文件：</p>
<ul>
<li><p>.frm文件：主要存放与表相关的数据信息，主要包括表结构的定义信息</p>
</li>
<li><p>.myd文件：主要用来存储表数据信息。</p>
</li>
<li><p>.myi文件：主要用来存储表数据文件中任何索引的数据树。</p>
</li>
</ul>
<h3 id="2-4-案例：一条SQL语句的完整执行流程"><a href="#2-4-案例：一条SQL语句的完整执行流程" class="headerlink" title="2.4 案例：一条SQL语句的完整执行流程"></a>2.4 案例：一条SQL语句的完整执行流程</h3><p>Sql语句执行流程</p>
<p>分析SQL语句如下：</p>
<pre class="line-numbers language-none"><code class="language-none">select c_id,first_name,last_name from customer where c_id=14;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>大体来说，MySQL 可以分为 Server层和存储引擎层两部分：</p>
<ol>
<li>Server层</li>
</ol>
<ul>
<li><p>包括：连接器、查询缓存、分析器、优化器、执行器等</p>
</li>
<li><p>涵盖 MySQL的大多数核心服务功能所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实</p>
</li>
<li><p>现比如：存储过程、触发器、视图等</p>
</li>
</ul>
<ol start="2">
<li>存储引擎层：</li>
</ol>
<ul>
<li><p>负责数据的存储和提取</p>
</li>
<li><p>可插拔式存储引擎：InnoDB、MyISAM、Memory 等</p>
</li>
<li><p>最常用存储引擎是InnoDB</p>
</li>
<li><p>从MySQL 5.5版本开始，默认存储引擎是InnoDB</p>
</li>
</ul>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425150324911.png"></p>
<h4 id="第一步：连接到数据库"><a href="#第一步：连接到数据库" class="headerlink" title="第一步：连接到数据库"></a>第一步：连接到数据库</h4><p>首先会连接到这个数据库上，这时候接待你的就是连接器。</p>
<pre class="line-numbers language-none"><code class="language-none">-- 连接命令
mysql -h127.0.0.1 -P3306 -uroot -p<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>连接完成后，如果你没有后续的动作，这个连接就处于空闲状态。客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数 wait_timeout 控制的默认值是 8 小时。</p>
<pre class="line-numbers language-none"><code class="language-none">mysql&gt; show processlist;
# 其中的 Command 列显示为“Sleep”的这一行，就表示现在系统里面有一个空闲连接。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425150409819.png"></p>
<h4 id="第二步：查缓存"><a href="#第二步：查缓存" class="headerlink" title="第二步：查缓存"></a>第二步：查缓存</h4><p>MySQL 拿到一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句。之前执行过的语句及其结果可能会以 key-value 对的形式，被直接缓存在内存中。key 是查询的语句hash之后的值，value是查询的结果。</p>
<ul>
<li><p>如果你的查询语句在缓存中，会被直接返回给客户端。</p>
</li>
<li><p>如果语句不在查询缓存中，就会继续后面的执行阶段。执行完成后，执行结果会被存入查询缓存中。</p>
</li>
</ul>
<p>如果查询命中缓存，MySQL 不需要执行后面的复杂操作就可以直接返回结果，效率会很高！但是不建议使用MySQL的内置缓存功能</p>
<h5 id="1）案例：查询缓存"><a href="#1）案例：查询缓存" class="headerlink" title="1）案例：查询缓存"></a>1）案例：查询缓存</h5><p>查询缓存默认是关闭的状态</p>
<pre class="line-numbers language-none"><code class="language-none"># 1）查看是否开启缓存
mysql&gt; show variables like 'query_cache_type';
# 2）查看缓存的命中次数：
mysql&gt; show status like 'qcache_hits';
# 3）开启缓存
在/etc/my.cnf文件中修改“query_cache_type”参数
值为`0或OFF`会禁止使用缓存。
值为`1或ON`将启用缓存，但以`SELECT SQL_NO_CACHE`开头的语句除外。
值为`2或DEMAND`时，只缓存以`SELECT SQL_CACHE`开头的语句。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>修改配置文件 my.cnf ，在文件中增加如下内容开启缓存：</p>
<pre class="line-numbers language-none"><code class="language-none">query_cache_type=1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查询SQL：</p>
<pre class="line-numbers language-none"><code class="language-none">mysql&gt; select * from city where city_id = 1;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>清空查询缓存</p>
<p>可以使用下面三个SQL来清理查询缓存：</p>
<pre class="line-numbers language-none"><code class="language-none">FLUSH QUERY CACHE; # 清理查询缓存内存碎片。
RESET QUERY CACHE; # 从查询缓存中移出所有查询。
FLUSH TABLES; # 关闭所有打开的表，同时该操作将会清空查询缓存中的内容。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="2）为什么不建议使用MySQL的查询缓存？"><a href="#2）为什么不建议使用MySQL的查询缓存？" class="headerlink" title="2）为什么不建议使用MySQL的查询缓存？"></a>2）为什么不建议使用MySQL的查询缓存？</h5><p>因为查询缓存往往弊大于利</p>
<ul>
<li><p>成本高：查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。因此很可能你费劲地把结果存起来，还没使用呢，就被一个更新全清空了。</p>
</li>
<li><p>命中率不高：对于更新压力大的数据库来说，查询缓存的命中率会非常低。除非你的业务就是有一张静态表，很长时间才会更新一次。比如，一个系统配置表，那这张表上的查询才适合使用查询缓存。</p>
</li>
<li><p>功能并不如专业的缓存工具更好：redis、memcache、ehcache…</p>
</li>
</ul>
<p>好在 MySQL 也提供了这种按需使用的方式。你可以将参数 query_cache_type 设置成 DEMAND，这样对于默认的 SQL 语句都不使用查询缓存。而对于你确定要使用查询缓存的语句，可以用 SQL_CACHE 显式指定，像下面这个语句一样：</p>
<pre class="line-numbers language-none"><code class="language-none">mysql&gt; select sql_cache * from city where city_id = 1;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>注意：MySQL 8.0 版本直接将查询缓存的整块功能删掉了</p>
</blockquote>
<h4 id="第三步：分析SQL语句"><a href="#第三步：分析SQL语句" class="headerlink" title="第三步：分析SQL语句"></a>第三步：分析SQL语句</h4><p>如果查询缓存没有命中，接下来就需要进入正式的查询阶段了。客户端程序发送过来的请求，实际上只是一个字符串而已，所以MySQL服务器程序首先需要对这个字符串做分析，判断请求的语法是否正确，然后从字符串中将要查询的表、列和各种查询条件都提取出来，本质上是对一个SQL语句编译的过程，涉及词法解析、语法分析、预处理器等。</p>
<ul>
<li><p>词法分析：词法分析就是把一个完整的 SQL 语句分割成一个个的字符串</p>
</li>
<li><p>语法分析：语法分析器根据词法分析的结果做语法检查，判断你输入的SQL 语句是否满足 MySQL语法。</p>
</li>
<li><p>预处理器：预处理器则会进一步去检查解析树是否合法，比如表名是否存在，语句中表的列是否存在等等，在这一步MySQL会检验用户是否有表的操作权限。</p>
</li>
</ul>
<h5 id="1）词法分析："><a href="#1）词法分析：" class="headerlink" title="1）词法分析："></a>1）词法分析：</h5><p>比如：这条简单的SQL语句，会被分割成10个字符串</p>
<pre class="line-numbers language-none"><code class="language-none"># 分隔前
select c_id,first_name,last_name from customer where c_id=14;
# 分隔后
select，c_id,first_name,last_name，from，customer，where，c_id，=，14<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>MySQL 同时需要识别出这个SQL语句中的字符串分别是什么，代表什么。</p>
<ul>
<li><p>把”select”这个关键字识别出来，这是一个查询语句</p>
</li>
<li><p>把“customer”识别成“表名 customer”</p>
</li>
<li><p>把“c_id识别成“列 c_id”。</p>
</li>
</ul>
<h5 id="2）语法分析："><a href="#2）语法分析：" class="headerlink" title="2）语法分析："></a>2）语法分析：</h5><p>如果语法正确就会根据 MySQL语法规则与SQL 语句生成一个数据结构，这个数据结构我们把它叫做解</p>
<p>析树。</p>
<blockquote>
<p>“You have an error in your SQL syntax”错误提醒就是在这个位置出现的。</p>
</blockquote>
<p>比如：下面这个语句</p>
<pre class="line-numbers language-none"><code class="language-none">mysql&gt; select c_id,first_name,last_name form customer where c_id=14;
[Err] 1064 - You have an error in your SQL syntax; check the manual that
corresponds to your MySQL server version for the right syntax to use near
'customer where c_id=14' at line 1
# 错误原因：from 写为 form<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>解析数举例：</p>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425152902076.png"></p>
<h5 id="3）预处理器："><a href="#3）预处理器：" class="headerlink" title="3）预处理器："></a>3）预处理器：</h5><p>预处理器则会进一步去检查解析树是否合法，比如表名是否存在，语句中表的列是否存在等等，在这一步MySQL会检验用户是否有表的操作权限。</p>
<p>预处理之后会得到一个新的解析树，然后调用对应执行模块</p>
<h4 id="第四步：优化SQL语句"><a href="#第四步：优化SQL语句" class="headerlink" title="第四步：优化SQL语句"></a>第四步：优化SQL语句</h4><p>优化器顾名思义就是对查询进行优化。作用是根据解析树生成不同的执行计划，然后选择最优的执行计划。</p>
<p>MySQL 里面使用的是基于成本模型的优化器，哪种执行计划Explain执行时成本最小就用哪种。而且它是io_cost和cpu_cost的开销总和，它通常也是我们评价一个查询的执行效率的一个常用指标。</p>
<p>查看上次查询成本开销，默认值是0</p>
<pre class="line-numbers language-none"><code class="language-none">show status like 'Last_query_cost';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>优化器可以做哪些优化呢？</p>
<ol>
<li><p>当有多个索引可用的时候，决定使用哪个索引；</p>
</li>
<li><p>在一个语句有多表关联（join）的时候，决定各个表的连接顺序，以哪个表为基准表。</p>
</li>
</ol>
<p>举个栗子：</p>
<p>（1）比如hello数据库中表customer上执行下面的语句，这个语句用到了两个索引 last_name 和address_id 。</p>
<ul>
<li><p>既可以使用last_name索引查询，然后过滤列address_id</p>
</li>
<li><p>也可以使用address_id索引查询，然后过滤列last_name。</p>
</li>
</ul>
<p>两种执行计划的结果是一样的，但是执行效率会有所不同，而优化器的作用就是决定选择使用哪一个方案。</p>
<p>使用explain工具可以查看优化器的执行计划</p>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425153009785.png"></p>
<p>注意：优化器最多就是辅助，作用很有限，我们的SQL语句不能依赖于MySQL的优化器去调优！如果SQL语句垃圾，则没有可优化的空间。优化SQL的根本在于掌握MySQL分析与调优知识。</p>
<h4 id="第五步：执行SQL语句"><a href="#第五步：执行SQL语句" class="headerlink" title="第五步：执行SQL语句"></a>第五步：执行SQL语句</h4><h5 id="1）判断执行权限"><a href="#1）判断执行权限" class="headerlink" title="1）判断执行权限"></a>1）判断执行权限</h5><p>开始执行的时候，要先判断一下你对这个表customer有没有执行查询的权限，如果没有，就会返回没有权限的错误。</p>
<p>举个栗子：</p>
<p>比如：我们新建一个用户mysql_user，只有表test的查询权限，没有表customer的查询权限。</p>
<pre class="line-numbers language-none"><code class="language-none">CREATE USER `mysql_user`@`localhost` IDENTIFIED BY '123456@heroA';
GRANT Select ON TABLE `hello`.`test` TO `mysql_user`@`localhost`;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>使用这个用户mysql_user连接mysql，执行下面的查询语句，就会返回没有权限的错误。</p>
<pre class="line-numbers language-none"><code class="language-none">mysql -umysql_user -p123456@heroA
mysql&gt; select * from customer where c_id=14;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425153104212.png"></p>
<h5 id="2）调用存储引擎接口查询"><a href="#2）调用存储引擎接口查询" class="headerlink" title="2）调用存储引擎接口查询"></a>2）调用存储引擎接口查询</h5><p>如果有权限，就使用指定的存储引擎打开表开始查询。执行器会根据表的引擎定义，去使用这个引擎提供的查询接口提取数据。</p>
<ul>
<li><p>c_id是主键执行流程：</p>
<ul>
<li><p>调用 InnoDB 引擎接口，从主键索引中检索c_id=14的记录。</p>
</li>
<li><p>主键索引等值查询只会查询出一条记录，直接将该记录返回客户端。</p>
</li>
<li><p>至此，这个语句就执行完成了。</p>
</li>
</ul>
</li>
<li><p>c_id不是主键执行流程：全表扫描</p>
<ul>
<li><p>调用 InnoDB 引擎接口取这个表的第一行，判断c_id 值是不是 14，如果不是则跳过，如果是则将这行缓存在结果集中；</p>
</li>
<li><p>调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。</p>
</li>
<li><p>执行器将上述遍历过程中所有满足条件的行组成的结果集返回给客户端。</p>
</li>
<li><p>至此，这个语句就执行完成了。</p>
</li>
</ul>
</li>
</ul>
<h2 id="3-MySQL的存储引擎之InnoDB"><a href="#3-MySQL的存储引擎之InnoDB" class="headerlink" title="3.MySQL的存储引擎之InnoDB"></a>3.MySQL的存储引擎之InnoDB</h2><h3 id="3-1-存储引擎种类"><a href="#3-1-存储引擎种类" class="headerlink" title="3.1 存储引擎种类"></a>3.1 存储引擎种类</h3><p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425160505248.png"></p>
<p>引擎怎么选择？</p>
<p>归纳为一句话：除非需要用到某些InnoDB不具备的特性，并且没有其他办法可以替代，否则都应该选择InnoDB引擎。也就是说，大部分情况下都选择InnoDB。</p>
<p>InnoDB和MyISAM存储引擎区别：</p>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425160530974.png"></p>
<p>案例：存储引擎查看与设置</p>
<p>在MySQL中可以使用不同的存储引擎</p>
<pre class="line-numbers language-none"><code class="language-none"># 查看支持的存储引擎
&gt; show engines<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425160546267.png"></p>
<p>只有InnoDB引擎支持事务、行锁、外键。</p>
<p>在选择引擎时尽可能使用InnoDB引擎。</p>
<ul>
<li><p>MyISAM：早期版本默认的引擎。</p>
</li>
<li><p>Memory：所有的数据都是保存在内存中。</p>
</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none"># 使用其他引擎，在mysql中默认使用InnoDB引擎，一个数据库中不同的表可以使用不同的引擎。
create table t_myisam(a int primary key, b int) engine=myisam;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="3-2-InnoDB架构图"><a href="#3-2-InnoDB架构图" class="headerlink" title="3.2 InnoDB架构图"></a>3.2 InnoDB架构图</h3><p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425160622858.png"></p>
<p>上图详细展示了InnoDB存储引擎的体系架构，从图中可见，InnoDB存储引擎由内存结构、磁盘结构两部分组成。</p>
<h3 id="3-4-内存结构"><a href="#3-4-内存结构" class="headerlink" title="3.4 内存结构"></a>3.4 内存结构</h3><p>InnoDB 内存结构主要分为如下四个区域：</p>
<ol>
<li><p>Buffer Pool 缓冲池</p>
</li>
<li><p>Change Buffer 修改缓冲</p>
</li>
<li><p>Adaptive Hash Index 自适应索引</p>
</li>
<li><p>Log Buffer 日志缓冲</p>
</li>
</ol>
<h4 id="1）缓冲池-Buffer-Pool"><a href="#1）缓冲池-Buffer-Pool" class="headerlink" title="1）缓冲池(Buffer Pool)"></a>1）缓冲池(Buffer Pool)</h4><p>缓冲池Buffer Pool 用于加速数据的访问和修改，通过将热点数据缓存在内存的方法，最大限度地减少磁盘 IO，加速热点数据读写。</p>
<ul>
<li><p>默认大小为128M，Buffer Pool 中数据以页为存储单位，其实现的数据结构是以页为单位的单链表。</p>
</li>
<li><p>由于内存的空间限制，Buffer Pool 仅能容纳最热点的数据。</p>
</li>
<li><p>Buffer Pool 使用LRU算法（Least Recently Used 最近最少使用）淘汰非热点数据页。</p>
<ul>
<li>LRU：根据页数据的历史访问来淘汰数据，如果数据最近被访问过，那么将来被访问的几率也更高，优先淘汰最近没有被访问到的数据。</li>
</ul>
</li>
<li><p>对于 Buffer Pool 中数据的查询，InnoDB 直接读取返回。对于 Buffer Pool 中数据的修改，InnoDB 直接在 Buffer Pool 中修改，并将修改写入redo log。# 查看innodb存储引擎状态，包含缓冲池、修改缓冲、自适应哈希状态信息、日志缓冲等信息…</p>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425160902770.png"></p>
</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none"># 查看innodb存储引擎状态，包含缓冲池、修改缓冲、自适应哈希状态信息、日志缓冲等信息...
mysql&gt; show engine innodb status;
# 查看InnoDB的Buffer Pool大小
mysql&gt; show variables like 'innodb_buffer_pool_size';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425160950333.png"></p>
<h4 id="2）修改缓冲-Change-Buffer"><a href="#2）修改缓冲-Change-Buffer" class="headerlink" title="2）修改缓冲(Change Buffer)"></a>2）修改缓冲(Change Buffer)</h4><p>Change Buffer（在 MySQL 5.6 之前叫 insert buffer，简称 ibuf ）是 InnoDB 5.5 引入的一种优化策略。Change Buffer 用于加速非热点数据中二级索引的写入操作。由于二级索引数据的不连续性，导致修改二级索引时需要进行频繁的磁盘 IO 消耗大量性能，Change Buffer 缓冲对二级索引的修改操作，同时将写操作录入 redo log 中，在缓冲到一定量或系统较空闲时进行 merge 操作将修改写入磁盘中。</p>
<p>Change Buffer 在系统表空间中有相应的持久化区域。</p>
<p>Change Buffer 大小默认占 Buffer Pool 的 25%，最大50%，在引擎启动时便初始化完成。其物理结构为一棵名为 ibuf 的 B Tree。</p>
<blockquote>
<p>二级索引就是辅助索引，除了聚簇索引之外的所有索引都是二级索引。</p>
<p>聚簇索引也叫聚集索引，索引组织表，指的是一种数据存储方式，指数据与索引的数据结构存储在一起。如 InnoDB 的主键索引中所有叶子节点都存储了对应行的数据。因为数据肯定只是存储在一个地方，所以一个表只能有一个聚集索引。</p>
</blockquote>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425161107989.png"></p>
<ul>
<li>周期性合并二级索引页</li>
<li>周期性净化磁盘中二级索引页</li>
</ul>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425161124139.png"></p>
<h4 id="3）自适应哈希索引-AHI"><a href="#3）自适应哈希索引-AHI" class="headerlink" title="3）自适应哈希索引(AHI)"></a>3）自适应哈希索引(AHI)</h4><p>自适应哈希索引（Adaptive Hash Index，AHI）用于实现对于热数据页的一次查询。是建立在索引之上的索引！使用聚簇索引进行数据页定位的时候需要根据索引树的高度从根节点走到叶子节点，通常需要3 到 4 次查询才能定位到数据。InnoDB 根据对索引使用情况的分析和索引字段的分析，通过自调优Self-tuning的方式为索引页建立或者删除哈希索引。</p>
<p>AHI 的大小为 Buffer Pool 的 1/64，在 MySQL 5.7 之后支持分区，以减少对于全局 AHI 锁的竞争，默认分区数为 8。</p>
<p>AHI 所作用的目标是频繁查询的数据页和索引页，而由于数据页是聚簇索引的一部分，因此 AHI 是建立在索引之上的索引，对于二级索引，若命中 AHI，则将直接从 AHI 获取二级索引页的记录指针，再根据主键沿着聚簇索引查找数据；若聚簇索引查询同样命中 AHI，则直接返回目标数据页的记录指针，此时就可以根据记录指针直接定位数据页。</p>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425161201586.png"></p>
<pre class="line-numbers language-none"><code class="language-none"># 查看innodb存储引擎状态，包含自适应哈希状态信息
mysql&gt; show engine innodb status;
# 查看是否开启自适应哈希配置，默认是开启的
mysql&gt; show variables like 'innodb_adaptive_hash_index';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425161221608.png"></p>
<h4 id="4）日志缓冲-Log-Buffer"><a href="#4）日志缓冲-Log-Buffer" class="headerlink" title="4）日志缓冲(Log Buffer)"></a>4）日志缓冲(Log Buffer)</h4><p>InnoDB 使用 Log Buffer 来缓冲日志文件的写入操作。内存写入加上日志文件顺序写的特点，使得</p>
<p>InnoDB 日志写入性能极高。</p>
<p>对于任何修改操作，都将录入诸如 redo log 与 undo log 这样的日志文件中，因此日志文件的写入操作非常频繁，却又十分零散。这些文件都存储在磁盘中，因此日志记录将引发大量的磁盘 IO。Log Buffer将分散的写入操作放在内存中，通过定期批量写入磁盘的方式提高日志写入效率和减少磁盘 IO。</p>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425161237982.png"></p>
<p>注意：这种将分散操作 改为 批量操作的优化方式将增加数据丢失的风险！</p>
<h3 id="3-3-磁盘文件之表空间"><a href="#3-3-磁盘文件之表空间" class="headerlink" title="3.3 磁盘文件之表空间"></a>3.3 磁盘文件之表空间</h3><p>在磁盘中，InnoDB 将所有数据都逻辑地存放在一个空间中，称为表空间（Tablespace）。表空间由段（Segment）、区（extent）、页（Page）组成。</p>
<ul>
<li><p>开启独立表空间innodb_file_per_table=1，每张表的数据都会存储到一个独立表空间，即 表名.ibd 文件</p>
</li>
<li><p>关闭独占表空间innodb_file_per_table=0，则所有基于InnoDB存储引擎的表数据都会记录到系统表空间，即 ibdata1 文件</p>
</li>
</ul>
<p>表空间是 InnoDB 物理存储中的最高层，目前的表空间类别包括：</p>
<ul>
<li><p>系统表空间（System Tablespace）</p>
</li>
<li><p>独立表空间（File-per-table Tablespace）</p>
</li>
<li><p>通用表空间（General Tablespace）</p>
</li>
<li><p>回滚表空间（Undo Tablespace）</p>
</li>
<li><p>临时表空间（The Temporary Tablespace）</p>
</li>
</ul>
<h4 id="1）系统表空间"><a href="#1）系统表空间" class="headerlink" title="1）系统表空间"></a>1）系统表空间</h4><p>系统表空间是 InnoDB 数据字典、双写缓冲、修改缓冲和回滚日志的存储位置，如果关闭独立表空间，它将存储所有表数据和索引。</p>
<p>它默认下是一个初始大小 12MB、名为 ibdata1 的文件，系统表空间所对应的文件由innodb_data_file_path 定义。</p>
<p>指定系统表空间文件自动增长后，其增长大小由 innodb_autoextend_increment 设置（默认为</p>
<p>64MB）且不可缩减，即使删除系统表空间中存储的表和索引，此过程释放的空间仅仅是在表空间文件中标记为已释放而已，并不会缩减其在磁盘中的大小。</p>
<ul>
<li><p>数据字典（Data Dictionary）： 数据字典是由各种表对象的元数据信息（表结构，索引，列信息等）组成的内部表</p>
</li>
<li><p>双写缓冲（Doublewrite Buffer）：双写缓冲用于保证写入磁盘时页数据的完整性，防止发生部分写失效问题。非常重要，在3.6小节重点介绍</p>
</li>
<li><p>修改缓冲（Change Buffer）： 内存中 Change Buffer 对应的持久化区域</p>
</li>
<li><p>回滚日志（Undo Log）：实现事务进行 回滚 操作时对数据的恢复。是实现多版本并发控制（MVCC）重要组成。</p>
</li>
</ul>
<h4 id="2）独立表空间"><a href="#2）独立表空间" class="headerlink" title="2）独立表空间"></a>2）独立表空间</h4><p>独立表空间用于存放每个表的数据和索引。其他类型的信息，如：回滚日志、双写缓冲区、系统事务信息、修改缓冲等仍存放于系统表空间内。因此即使用了独立表空间，系统表空间也会不断增长。在5.7版本中默认开启</p>
<p>开启独立表空间（File-per-table TableSpace）（ innodb_file_per_table=ON ）之后，InnoDB 会为每个数据库单独创建子文件夹，数据库文件夹内为每个数据表单独建立一个表空间文件 table.ibd 。同时创建一个 table.frm 文件用于保存表结构信息。</p>
<p>每个独立表空间的初始大小是 96KB。</p>
<h4 id="3）其他"><a href="#3）其他" class="headerlink" title="3）其他"></a>3）其他</h4><h5 id="1-通用表空间"><a href="#1-通用表空间" class="headerlink" title="1.通用表空间"></a>1.通用表空间</h5><p>通用表空间（General Tablespace）是一个由 CREATE TABLESPACE 命令创建的共享表空间，创建时必须指定该表空间名称和 ibd 文件位置，ibd 文件可以放置于任何 MySQL 有权限的地方。该表空间内可以容纳多张数据表，同时在创建时可以指定该表空间所使用的默认引擎。</p>
<p>通用表空间存在的目的是为了在系统表空间与独立表空间之间作出平衡。系统表空间与独立表空间中的表可以向通用表空间移动，反之亦可，但系统表空间中的表无法直接与独立表空间中的表相互转化。</p>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425161548031.png"></p>
<h5 id="2-Undo-表空间"><a href="#2-Undo-表空间" class="headerlink" title="2. Undo 表空间"></a>2. Undo 表空间</h5><p>Undo TableSpace 用于存放一个或多个 undo log 文件。默认 undo log 存储在系统表空间中，MySql5.7中支持自定义 Undo log 表空间并存储所有 undo log。一旦用户定义了 Undo Tablespace，则系统表空间中的 Undo log 区域将失效。对于 Undo Tablespace 的启用必须在 MySQL 初始化前设置，Undo Tablespace 默认大小为 10MB。Undo Tablespace 中的 Undo log 表可以进行 truncate 操作。</p>
<h5 id="3-临时表空间"><a href="#3-临时表空间" class="headerlink" title="3.临时表空间"></a>3.临时表空间</h5><p>MySQL 5.7 之前临时表存储在系统表空间中，这样会导致 ibdata 在使用临时表的场景下疯狂增长。5.7版本之后 InnoDB 引擎从系统表空间中抽离出临时表空间（Temporary Tablespace），用于独立保存临时表数据及其回滚信息。该表空间文件路径由 innodb_temp_data_file_path 指定，但必须继承innodb_data_home_dir 。</p>
<h3 id="3-5-磁盘文件之存储结构"><a href="#3-5-磁盘文件之存储结构" class="headerlink" title="3.5 磁盘文件之存储结构"></a>3.5 磁盘文件之存储结构</h3><p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425161555902.png"></p>
<h4 id="1）段【Segment】"><a href="#1）段【Segment】" class="headerlink" title="1）段【Segment】"></a>1）段【Segment】</h4><p>表空间由各个段（Segment）组成，创建的段类型分为数据段、索引段、回滚段等。由于 InnoDB 采用聚簇索引与 B+ 树的结构存储数据，所以事实上数据页和二级索引页仅仅只是 B+ 树的叶子节点，因此数据段称为 Leaf node segment，索引段其实指的是 B+ 树的非叶子节点，称为 Non-Leaf node segment。一个段会包含多个区，至少会有一个区，段扩展的最小单位是区。【在索引篇会详细讲解</p>
<p>B+数据结构】</p>
<ul>
<li><p>数据段称为 Leaf node segment</p>
</li>
<li><p>索引段称为 Non-Leaf node segment</p>
</li>
</ul>
<h4 id="2）区【Extent】"><a href="#2）区【Extent】" class="headerlink" title="2）区【Extent】"></a>2）区【Extent】</h4><p>区（Extend）是由连续的页组成的空间，大小固定为 1MB，由于默认页大小为 16K，因此一个区默认存储 64 个连续的页。如果页大小调整为 4K，则 256 个连续页组成一个区。为了保证页的连续性，InnoDB 存储引擎会一次从磁盘申请 4 ~ 5 个区。</p>
<h4 id="3）页【Page】"><a href="#3）页【Page】" class="headerlink" title="3）页【Page】"></a>3）页【Page】</h4><p>页（Page）是 InnoDB 的基本存储单位，每个页大小默认为 16K，从 InnoDB1.2.x 版本开始，可通过设置 innodb_page_size 修改为 4K、8K、16K。InnoDB 首次加载后便无法更改。</p>
<pre class="line-numbers language-none"><code class="language-none"># 查看MySQL页大小
show variables like 'innodb_page_size';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p>MySQL规定一个页上最少存储2个数据项。如果向一个页插入数据时，这个页已经满了，就会从区中分配一个新页。如果向索引树叶子节点中间的一个页中插入数据，如果这个页是满的，就会发生页分裂。</p>
<p>操作系统读写磁盘最小单位也是页，当然此页非毕页！Linux的页一般是4K，通过命令查看：</p>
<pre class="line-numbers language-none"><code class="language-none"># 默认 4096 4K
getconf PAGE_SIZE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p>由此可知，InnoDB从磁盘中读取一个数据页，操作系统会分4次从磁盘文件中读取数据到内存。写入也是一样的，需要分4次从内存写入到磁盘中。</p>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425161652374.png"></p>
<h4 id="4）行【Row】"><a href="#4）行【Row】" class="headerlink" title="4）行【Row】"></a>4）行【Row】</h4><p>InnoDB的数据是以行为单位存储的，1个页中包含多个行。在MySQL5.7中，InnoDB提供了4种行格式：Compact、Redundant、Dynamic和Compressed行格式，Dynamic为MySQL5.7默认的行格式。</p>
<p>创建表时可以指定行格式：</p>
<pre class="line-numbers language-none"><code class="language-none">CREATE TABLE t1 (c1 INT) ROW_FORMAT=DYNAMIC;
#修改表的行格式
ALTER TABLE tablename ROW_FORMAT=行格式名称;
#修改默认行格式
SET GLOBAL innodb_default_row_format=DYNAMIC;
#查看表行格式
SHOW TABLE STATUS LIKE 't1';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>InnoDB行格式官网：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-row-format.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-row-format.html</a></p>
</blockquote>
<h3 id="3-6-内存数据落盘"><a href="#3-6-内存数据落盘" class="headerlink" title="3.6 内存数据落盘"></a>3.6 内存数据落盘</h3><h4 id="1）整体思路分析"><a href="#1）整体思路分析" class="headerlink" title="1）整体思路分析"></a>1）整体思路分析</h4><p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425161813722.png"></p>
<p>在数据库中进行读取操作，将从磁盘中读到的页放在缓冲区中，下次再读相同的页时，首先判断该页是否在缓冲区中。若在缓冲区中，称该页在缓冲区中被命中，直接读取该页。否则读取磁盘上的页。</p>
<p>对于数据库中页的修改操作，则首先修改在缓冲区中的页，然后再以一定的频率刷新到磁盘上。页从缓冲区刷新回磁盘的操作并不是在每次页发生更新时都触发，而是通过一种称为CheckPoint的机制刷新回磁盘。</p>
<p>内存数据落盘要考虑的核心问题：高性能写入数据，同时保证数据的绝对安全性！</p>
<p>数据库灵魂三问：</p>
<p>① 写入性能如何保证？</p>
<p>分散写入操作放在内存中，通过定期批量写入磁盘的方式提高写入效率减少磁盘 IO。</p>
<p>② 如何持久化？也就是修改后的数据如何到磁盘中去。内存里缓冲池中的数据页要完成持久化通过两个流程来完成</p>
<ul>
<li><p>通过CheckPoint机制进行脏页落盘</p>
</li>
<li><p>日志先行，所有操作前先写Redo日志</p>
</li>
</ul>
<p>③ 数据安全性怎么保证？</p>
<ul>
<li><p>记录操作日志：Force Log at Commit机制与Write Ahead Log（WAL）策略</p>
</li>
<li><p>CheckPoint机制</p>
</li>
<li><p>Double Write机制</p>
</li>
</ul>
<h4 id="2）脏页落盘"><a href="#2）脏页落盘" class="headerlink" title="2）脏页落盘"></a>2）脏页落盘</h4><p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425161948918.png"></p>
<p>什么是脏页？</p>
<p>对于数据库中页的修改操作，则首先修改在缓冲区中的页，缓冲区中的页与磁盘中的页数据不一致，所以称缓冲区中的页为脏页。然后再以一定的频率将脏页刷新到磁盘上。页从缓冲区刷新回磁盘的操作并不是在每次页发生更新时触发，而是通过一种称为CheckPoint的机制刷新回磁盘。</p>
<p>为什么不是每次更新直接写入磁盘呢？</p>
<ul>
<li><p>如果每次一个页发生变化就进行落盘，每次落盘一个页，必然伴随着4次IO操作，那么性能开销会非常大。而且这个开销是随着写入操作的增加指数级增长的！</p>
</li>
<li><p>如果数据长期在内存中保存，那么数据就存在安全性风险！</p>
</li>
<li><p>InnoDB采用了Write Ahead Log（WAL）策略和Force Log at Commit机制实现事务级别下数据的持久性。</p>
<ul>
<li><p>Force Log at Commit机制：当事务提交时，所有事务产生的日志都必须刷到磁盘。如果日志刷新成功后，缓冲池中的数据刷新到磁盘前数据库发生了宕机，那么重启时，数据库可以从日志中恢复数据。这样可以保证数据的安全性</p>
</li>
<li><p>Write Ahead Log（WAL）策略：要求数据的变更写入到磁盘前，首先必须将内存中的日志写入到磁盘；InnoDB 的 WAL（Write Ahead Log）技术的产物就是 redo log，对于写操作，永远都是日志先行，先写入 redo log 确保一致性之后，再对修改数据进行落盘。</p>
</li>
<li><p>说白了保证数据的持久性与安全性我们采用记录日志的方式，那么也就是说，日志安全了，数据就安全了！</p>
</li>
</ul>
</li>
</ul>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425162114572.png"></p>
<p>怎么确保日志就能安全的写入系统呢？</p>
<ul>
<li>为了确保每次日志都写入到redo日志文件，在每次将redo日志缓冲写入redo日志后，调用一次fsync操作，将缓冲文件从文件系统缓存中真正写入磁盘。</li>
</ul>
<p>这样做不就等同于数据直接写入磁盘吗？</p>
<ul>
<li><p>redo日志不会记录完整的一页数据，因为这样日志太大，它只会记录那次（sequence）如何操作了（update,insert）哪页(page)的哪行(row)</p>
</li>
<li><p>日志是顺序写入，而数据是随机写入。顺序写入效率更高</p>
</li>
<li><p>日志也不是改一条写一条，而是采用redo 日志落盘策略来兼顾安全性与性能！</p>
</li>
<li><p>可以通过 innodb_flush_log_at_trx_commit 来控制redo日志刷新到磁盘的策略。</p>
</li>
</ul>
<p>接下来我们看redo日志如何落盘</p>
<h4 id="3）Redo日志落盘"><a href="#3）Redo日志落盘" class="headerlink" title="3）Redo日志落盘"></a>3）Redo日志落盘</h4><p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425162143090.png"></p>
<p>Log Buffer写入磁盘的时机由参数 innodb_flush_log_at_trx_commit 控制，此属性控制每次事务提交时InnoDB的行为。是InnoDB性能调优的一个基础参数，涉及InnoDB的写入性能和数据安全性。默认1，表示事务提交后立即落盘。</p>
<pre class="line-numbers language-none"><code class="language-none"># 查看写入时机参数配置
show VARIABLES like 'innodb_flush_log_at_trx_commit';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>innodb_flush_log_at_trx_commit 配置详解：</p>
<ul>
<li><p>为0时：事务提交时，不会立即把 log buffer里的数据写入到redo log日志文件的。而是等待主线程每秒写入一次。</p>
<ul>
<li><p>如果MySQL崩溃或者服务器宕机，此时内存里的数据会全部丢失，最多会丢失1秒的事务。</p>
</li>
<li><p>写入效率最高，但是数据安全最低；</p>
</li>
</ul>
</li>
<li><p>为1时：每次事务提交时，会将数据将从log buffer写入redo日志文件与文件系统缓存，并同时fsync刷新到磁盘中。</p>
<ul>
<li><p>系统默认配置为1，MySQL崩溃已经提交的事务不会丢失，要完全符合ACID必须使用默认设置1。</p>
</li>
<li><p>写入效率最低，但是数据安全最高；</p>
</li>
</ul>
</li>
<li><p>为2时：事务提交时，也会将数据写入redo日志文件与文件系统缓存，但是不会调用fsync，而是让操作系统自己去判断何时将缓存写入磁盘。</p>
<ul>
<li><p>事务提交都会将数据刷新到操作系统缓冲区，可以认为是已经持久化到磁盘，但没有真正意义上持久化到磁盘。</p>
</li>
<li><p>如果MySQL崩溃已经提交的事务不会丢失。但是如果服务器宕机或者意外断电，操作系统缓存内的数据会丢失，所以最多丢失1秒的事务。</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>Tips. 用户程序写入数据到磁盘文件时，需要调用操作系统的接口，操作系统本身是有缓冲区的，之后依赖操作系统机制不时的将缓存中刷新到磁盘文件中。用户程序可以执行fsync操作将操作系统缓冲区的数据刷入到磁盘文件中。</p>
</blockquote>
<p>设置为1时，安全性最好但写入效率比较低。如果没有设置为1，是无法满足ACID的D持久性由于MySQL执行刷新操作fsync() 是阻塞的，所以磁盘刷新速度比较慢，如果开启了1MySQL性能会下降。0是性能最好的模式，但是会存在丢失数据的风险。2是介于1和0之间的一个选择，数据的安全性会依赖于操作系统是否稳定。在配置这一项的时候需要慎重考虑。</p>
<h4 id="4）CheckPoint检查点机制"><a href="#4）CheckPoint检查点机制" class="headerlink" title="4）CheckPoint检查点机制"></a>4）CheckPoint检查点机制</h4><h5 id="1-什么是CheckPoint？"><a href="#1-什么是CheckPoint？" class="headerlink" title="1.什么是CheckPoint？"></a>1.什么是CheckPoint？</h5><p>Checkpoint要做的事情是将缓冲池中的脏页数据刷到磁盘上。CheckPoint决定了脏页落盘的时机、条件及脏页的选择，不同的CheckPoint做法并不相同。</p>
<h5 id="2-CheckPoint要解决什么问题？"><a href="#2-CheckPoint要解决什么问题？" class="headerlink" title="2.CheckPoint要解决什么问题？"></a>2.CheckPoint要解决什么问题？</h5><ol>
<li><p>脏页落盘：避免数据更改直接操作磁盘</p>
</li>
<li><p>缩短数据库的恢复时间：当数据库发生宕机时，数据库不需要重做所有的日志，因为Checkpoint之前的页都已经刷新回磁盘。数据库只需对Checkpoint后的redo日志进行恢复，这样就大大缩短了恢复的时间。</p>
</li>
<li><p>缓冲池不够用时，将脏页刷新到磁盘：当缓冲池不够用时，根据LRU算法会溢出最近最少使用的页，若此页为脏页，那么需要强制执行Checkpoint，将脏页也就是页的新版本刷回磁盘。</p>
</li>
<li><p>redo日志不可用时，刷新脏页：当redo日志出现不可用时，Checkpoint将缓冲池中的页至少刷新到当前redo日志的位置</p>
<ol>
<li><p>数据库系统对redo日志的设计都是循环使用的，并不是让其无限增大的。</p>
</li>
<li><p>如果当数据库宕机恢复操作时，不需要redo日志中的部分redo日志，这部分就可以被覆盖重用。</p>
</li>
<li><p>InnoDB通过LSN（Log Sequence Number）来标记日志刷新的版本。LSN是8字节的数字，每个页有LSN，redo日志中也有LSN，Checkpoint也有LSN。</p>
</li>
</ol>
</li>
</ol>
<p>可以通过命令 SHOW ENGINE INNODB STATUS 来观察：</p>
<pre class="line-numbers language-none"><code class="language-none">mysql&gt; show engine innodb status<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425162433981.png"></p>
<h5 id="3-Checkpoint分类"><a href="#3-Checkpoint分类" class="headerlink" title="3.Checkpoint分类"></a>3.Checkpoint分类</h5><p>在InnoDB存储引擎内部，有两种Checkpoint，分别为：Sharp Checkpoint、Fuzzy Checkpoint</p>
<ul>
<li><p>sharp checkpoint：在关闭数据库的时候，将buffer pool中的脏页全部刷新到磁盘中。</p>
</li>
<li><p>fuzzy checkpoint：数据库正常运行时，在不同的时机，将部分脏页写入磁盘。仅刷新部分脏页到磁盘，也是为了避免一次刷新全部的脏页造成的性能问题。</p>
</li>
</ul>
<p>Fuzzy Checkpoint：默认方式，只刷新一部分脏页，不是刷新所有脏页；</p>
<p>主要有以下几种情况：</p>
<ul>
<li><p>Master Thread Checkpoint ：在Master Thread中，会以每秒或者每10秒一次的频率，将部分脏页从内存中刷新到磁盘，这个过程是异步的。正常的用户线程对数据的操作不会被阻塞。</p>
</li>
<li><p>FLUSH_LRU_LIST Checkpoint：缓冲池不够用时，根据LRU算法会淘汰掉最近最少使用的页，如果该页是脏页的话，会强制执行CheckPoint，将该脏页刷回磁盘（由Page Cleaner Thread完成）；</p>
</li>
<li><p>Async/Sync Flush Checkpoint：重做日志不可用的情况，需要强制从脏页列表中选取一些脏页刷盘（由Page Cleaner Thread完成）。由于磁盘是一种相对较慢的存储设备，内存与磁盘的交互是一个相对较慢的过程。innodb_log_file_size定义的是一个相对较大的值，正常情况下，由前面两种checkpoint刷新脏页到磁盘，在前面两种checkpoint刷新脏页到磁盘之后，脏页对应的redo log 空间随即释放，一般不会发生Async/Sync Flush checkpoint。</p>
</li>
<li><p>Dirty Page too much：即脏页数量太多，导致强制进行Checkpoint。由参数innodb_max_dirty_pages_pt 来控制，默认75（即75%）。当脏页数量占据75%缓冲池时，刷新一部分脏页到磁盘。（由Page Cleaner Thread完成）</p>
</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">show variables like 'innodb_max_dirty_pages_pct';<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425162631110.png"></p>
<h4 id="5）Double-Write双写"><a href="#5）Double-Write双写" class="headerlink" title="5）Double Write双写"></a>5）Double Write双写</h4><h5 id="1-脏页落盘出现的问题：写失效"><a href="#1-脏页落盘出现的问题：写失效" class="headerlink" title="1.脏页落盘出现的问题：写失效"></a>1.脏页落盘出现的问题：写失效</h5><p>我们知道脏页会在某些场景下进行刷盘，将缓冲池内的脏页数据落地到磁盘。因为存储引擎缓冲池内的数据页大小默认为16KB，而文件系统一页大小为4KB，所以在进行刷盘操作时，就有可能发生如下场景：</p>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425162646294.png"></p>
<p> 如图所示，数据库准备刷新脏页时，将16KB的刷入磁盘，但当写入了8KB时，就宕机了这种情况被称为写失效（partial page write）。</p>
<h5 id="2-怎么解决？"><a href="#2-怎么解决？" class="headerlink" title="2.怎么解决？"></a>2.怎么解决？</h5><blockquote>
<p>上备胎</p>
</blockquote>
<p>Doublewrite其实就是写两次，解决写失效问题，需要用到Doublewrite机制，简单来说就是在redo日志前，对需要写入的页的做个副本，当写失效发生时，通过页的副本来还原该页再重做，这就是所谓的double write。写失效后redo日志也是无法进行恢复的，因为redo日志记录的是对页的物理修改。</p>
<p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425162749031.png"></p>
<h6 id="Double-Write分两个部分："><a href="#Double-Write分两个部分：" class="headerlink" title="Double Write分两个部分："></a>Double Write分两个部分：</h6><ul>
<li><p>内存中的Doublewrite buffer，大小为2MB</p>
</li>
<li><p>磁盘上的Doublewrite buffer，大小为2MB，连续的128个页，相当于两个extent</p>
</li>
</ul>
<h6 id="Double-write脏页刷新流程："><a href="#Double-write脏页刷新流程：" class="headerlink" title="Double write脏页刷新流程："></a>Double write脏页刷新流程：</h6><ol>
<li><p>首先复制：脏页刷新时不直接写磁盘，而是先将脏页复制到内存的Doublewrite buffer</p>
</li>
<li><p>再顺序写：内存的Doublewrite buffer分两次，每次1MB顺序地写入共享表空间的物理磁盘上，会立即调用fsync函数同步OS缓存到磁盘中，顺序写性能好</p>
</li>
<li><p>最后离散写：内存的Doublewrite buffer最后将页写入各自表空间文件中，离散写较顺序写入差一些</p>
</li>
</ol>
<h5 id="3-Double-write崩溃恢复"><a href="#3-Double-write崩溃恢复" class="headerlink" title="3.Double write崩溃恢复"></a>3.Double write崩溃恢复</h5><p><img src="/../../../../../images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Java/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B/image-20250425162843492.png"></p>
<p>如果脏页数据未来得及落盘，系统就奔溃了，直接应用redo日志重新执行脏页落盘。</p>
<p>如果操作系统在将页写入磁盘的过程中发生了崩溃，其恢复过程如下：</p>
<ol>
<li><p>首先InnoDB存储引擎从系统表空间中的Double write中找到该页的一个副本</p>
</li>
<li><p>然后将其复制到独立表空间</p>
</li>
<li><p>最后清楚redo日志，完成数据恢复</p>
</li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://gustavo1841.github.io" rel="external nofollow noreferrer">Gustavo</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://gustavo1841.github.io/2025/04/25/ji-suan-ji/java/shu-ju-ku-zhuan-ti/guan-xi-xing/shu-ju-ku-xi-tong-yuan-li-mysql-jia-gou-pian/">https://gustavo1841.github.io/2025/04/25/ji-suan-ji/java/shu-ju-ku-zhuan-ti/guan-xi-xing/shu-ju-ku-xi-tong-yuan-li-mysql-jia-gou-pian/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://gustavo1841.github.io" target="_blank">Gustavo</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/">
                                    <span class="chip bg-color">计算机</span>
                                </a>
                            
                                <a href="/tags/Java/">
                                    <span class="chip bg-color">Java</span>
                                </a>
                            
                                <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                                    <span class="chip bg-color">数据库</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'Ov23liq75W6OMBRsILFM',
        clientSecret: 'ed377d268bc9ef7ea8e847b6de012be660bd8e3e',
        repo: 'gustavo1841.github.io',
        owner: 'gustavo1841',
        admin: "gustavo1841",
        id: '2025-04-25T14-55-17',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2025/04/25/jiao-yi-ti-xi/introduction-to-financial-markets/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/95.jpg" class="responsive-img" alt="introduction to financial markets">
                        
                        <span class="card-title">introduction to financial markets</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-04-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/trader/" class="post-category">
                                    trader
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/trader/">
                        <span class="chip bg-color">trader</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/04/24/ji-suan-ji/java/wang-luo-bian-cheng/wang-luo-bian-cheng-xia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/279.jpg" class="responsive-img" alt="网络编程—下">
                        
                        <span class="card-title">网络编程—下</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-04-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" class="post-category">
                                    计算机
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/">
                        <span class="chip bg-color">计算机</span>
                    </a>
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                    <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">
                        <span class="chip bg-color">网络编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Gustavo<br />'
            + '文章作者: Gustavo<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1,h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2025</span>
            
            <a href="/about" target="_blank">Gustavo</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">1406.2k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2025";
                        var startMonth = "1";
                        var startDate = "13";
                        var startHour = "18";
                        var startMinute = "54";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/gustavo1841" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:huangwei0246@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1142488172" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1142488172" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    
        <!-- <script src='https://unpkg.com/mermaid@latest/dist/mermaid.min.js'></script> -->
        <script src='/libs/mermaid/mermaid.min.js'></script>
        <script>
          if (window.mermaid) {
            mermaid.initialize({theme: 'forest'});
          }
        </script>
    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
